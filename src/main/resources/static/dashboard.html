<html>
<head>
<style>
    body {
          font-family: arial, sans-serif;
    }
    table {
    border-collapse: collapse;
    width: 100%;
    }

    td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
    }

    tr:nth-child(even) {
    background-color: #dddddd;
    }
    .vertical-contain {
        margin-left: 20px;
        margin-right: 20px;

        padding-left:20px;
        padding-right:20px;
        align-items: center;
        display: flex;
        flex-direction: column;
    }
    .horizontal-contain{
        display: flex;
        flex-direction: row;
    }
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .right-nav a, .logout-link {
        margin-left: 20px;
        text-decoration: none;
        color: #333;
        font-weight: bold;
    }

    .right-nav a:hover {
        color: #4CAF50;
    }

    .logout-link {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
    }

    .logout-link:hover {
        color: #ff4d4d;
    }

    .refresh-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 8px 15px;
        margin:0;
        border-radius: 4px;
        cursor: pointer;
    }
</style>
</head>
<body>
<div class="top-bar">
    <div class="left-actions">
        <button class="refresh-btn" onclick="populateTable()">Refresh</button>
    </div>
    <div class="right-nav">
        <a href="/register-device.html">Register Device</a>
        <a href="/login.html" id="loginLink">Login</a>
        <button onclick="logout()" class="logout-link">Logout</button>
    </div>
</div>
<div class="vertical-contain">
        <h2>Data DashBoard</h2>

    <table id="dashboard-table">
        <thead> 
            <tr>
            <th>Device</th>
            <th>Temperature</th>
            <th>Soil Moisture</th>
            <th>Captured At</th>

        </tr>
        </thead>
        <tbody id="dashboard-table-body">

        </tbody>

    </table>
    <p id="pageNumber"></p>
    <div class="horizontal-contain">
        <button id="prevBtn" onclick="lastPage()">Back</button>
        <button id="nextBtn" onclick="nextPage()">Next</button>
    </div>
    
</div>

</body>

<script>
    let currentPage = 0; // Global variable to track the page
    const token = localStorage.getItem("token");

    if(!token){
        window.alert("you must log in first!!");
        window.location.href = "/login.html";
    }else{
        populateTable();
    }

    function lastPage(){
        if(currentPage > 0) {
            currentPage--;
            populateTable();
        }    
    }
    function nextPage(){
        currentPage++;
        populateTable();
    }

    async function populateTable(){
        document.getElementById("pageNumber").innerHTML = `Page: ${currentPage + 1}`;
        const data = await getData(currentPage);

        if(!data || !Array.isArray(data)) return;
        const parent = document.getElementById("dashboard-table-body");
        parent.innerHTML=""; //clear the table for refresh
        data.forEach(element => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${element.deviceName}</td>
                <td>${element.temperature}</td>
                <td>${element.moisture}</td>
                <td>${new Date(element.capturedAt).toLocaleString()}</td>
            `;
            parent.appendChild(row);
        });
    }
    async function getData(currentPage){
        try{
            const response = await fetch(`/api/readings?page=${currentPage}`, {
            method: "GET",
            headers:{"Authorization": `Bearer ${token}`}
        })

            const data = await response.json();

            document.getElementById("nextBtn").disabled = data.last;
            document.getElementById("prevBtn").disabled = data.first;
            console.log(data);
            return data.content; //actual content, not including metadata
        }catch (error){
            console.log("Dashboard data fetch error" + error);
        }
    }
</script>
</html>
